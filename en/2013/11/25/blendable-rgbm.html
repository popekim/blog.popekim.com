<!DOCTYPE html>
<html lang="en">


<head>

    <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-NHD74QDQ');</script>
    <!-- End Google Tag Manager -->


    <link href="http://gmpg.org/xfn/11" rel="profile">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="content-type" content="text/html; charset=utf-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5">

    <title>Blendable RGBM | PPMC</title>
    
    
    
    <link rel="stylesheet" href="/en/assets/lib/bootstrap/css/bootstrap.min.css" />
    <link rel="stylesheet" href="/en/assets/css/site.css?1772152258827111107" />
    <link rel="stylesheet" href="/en/assets/css/prism-pocu.min.css" />

    <link rel="shortcut icon" href="/en/assets/favicon.ico" />

    <link rel="canonical" href="https://blog.popekim.com/en/2013/11/25/blendable-rgbm.html" />

<link type="application/atom+xml" rel="alternate" href="https://blog.popekim.com/en/feed.xml" title="PPMC | All" />
<link type="application/atom+xml" rel="alternate" href="https://blog.popekim.com/en/feed/dev.xml" title="PPMC | Dev" />
<link type="application/atom+xml" rel="alternate" href="https://blog.popekim.com/en/feed/music.xml" title="PPMC | Music" />
<link type="application/atom+xml" rel="alternate" href="https://blog.popekim.com/en/feed/personal.xml" title="PPMC | Personal" />

    <link rel="alternate" href="https://blog.popekim.com/en/2013/11/25/blendable-rgbm.html" hreflang="en" />
    <link rel="alternate" href="https://blog.popekim.com/ko/2013/11/25/blendable-rgbm.html" hreflang="ko" />

    <script defer src="https://use.fontawesome.com/releases/v5.15.4/js/all.js" integrity="sha384-rOA1PnstxnOBLzCLMcre8ybwbTmemjzdNlILg8O7z1lUkLXozs4DHonlDtnE7fpc" crossorigin="anonymous"></script>
    
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1575918182992085" crossorigin="anonymous"></script>
    
</head>

<body>

    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NHD74QDQ"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->

    
<nav class="navbar navbar-expand-lg fixed-top navbar-light shadow-sm px-3 px-sm-0 py-lg-3 bg-white">
    <div class="container">
        <a class="navbar-brand" href="/en/">
            <img class="mt-2 mb-2" src="/en/assets/img/navbar_logo.png" />
        </a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavDropdown"
            aria-controls="navbarNavDropdown" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNavDropdown">
<ul class="navbar-nav ml-auto mr-lg-3">
    <li class="nav-item">
        <a class="nav-link font-weight-bold" href="/en/about.html">about</a>
    </li>
    <li class="nav-item">
        <a class="nav-link font-weight-bold" href="/en/archives/">archives</a>
    </li>
    
    
        
        
        <li class="nav-item">
            <a class="nav-link font-weight-bold" href="/en/categories/dev">cat:dev</a>
        </li>
    
        
        
        <li class="nav-item">
            <a class="nav-link font-weight-bold" href="/en/categories/music">cat:music</a>
        </li>
    
        
        
        <li class="nav-item">
            <a class="nav-link font-weight-bold" href="/en/categories/personal">cat:personal</a>
        </li>
    
</ul>

        </div>
    </div>
</nav>

    <div class="container doc">
        <div class="pt-4 pb-4">
    <div class="row no-gutters">
        <div class="col-lg-10 offset-lg-1">
            <article class="shadow--md px-md-5 py-md-5 border--md rounded">
                <header>
                    <h1 class="card-title text-center mb-4 font-weight-bold">Blendable RGBM</h1>
                    <div class="h6 text-muted text-center mb-4 mb-md-5"><img width="70" src="/en/assets/img/authors/pope.gif" class="rounded-circle mx-auto d-block mb-3" />
                        <span
                            class="h6 border border-dark border-left-0 border-top-0 border-bottom-0 pr-2 pr-lg-3 align-middle">
                            Pope Kim</span>
                        

                        <span class="h6 text-muted align-middle pl-1 pl-lg-2">
                            <i class="far fa-calendar-alt mr-2 opacity-75"></i>
                            Nov 25, 2013
                        </span><ul class="list-inline list-unstyled mt-2">
                            <li class="list-inline-item align-middle opacity-75"><small><i
                                        class="fas fa-tags"></i></small></li>
                        
                            
                             
                            
                            <li class="list-inline-item align-middle">
                                <small><a class="tag-link" href="/en/tags/graphics/">graphics</a></small>
                            </li>
                            
                             
                            
                            <li class="list-inline-item align-middle">
                                <small><a class="tag-link" href="/en/tags/shader/">shader</a></small>
                            </li></ul></div>
                </header>
                <section class="pt-4 pb-4 pb-md-5 border border-top-0 border-right-0 border-left-0">
                    
                    
                    <h1 id="what-is-rgbm">What is RGBM?</h1>
<p>Using a fat buffer(16 bit-per-channel) is the most intuitive way to store a HDR render target, but it was too slow and it used too much memory, so we decided to encode(pack) it into a 8 bit-per-channel buffer. There are different packing methods, but I believe the most widely used method was <a href="http://graphicrants.blogspot.ca/2009/04/rgbm-color-encoding.html">RGBM</a>. (also this link has a nice summary of LogLUV too, so give it a read if you are not familiar with this topic at all)</p>

<p>Packing.. Yum…. It's nice: it saves bandwidth and memory…</p>

<h1 id="rgbm-limitations">RGBM Limitations</h1>
<p>But… YUCK we couldn't do one thing that artists absolutely love to see…. ALPHA BLENDING..</p>

<p>We simply can't do alpha blending on a RGBM buffer. In other words, you shouldn't have semi-transparent objects. Why? With RGBM, you need this formula to blend pixels properly.</p>

<pre><code>( DestColour * DestMultiplier * InvSrcAlpha + SrcColor * SrcAlpha ) / SrcMultiplier
</code></pre>

<p>Let's look at some not-too-obvious parameters:</p>

<ul>
  <li><strong>DestMultiplier</strong>: stored in DestAlpha channel, which is easily available to our blend unit</li>
  <li><strong>SrcMultiplier</strong>: alpha channel output from shader</li>
  <li><strong>SrcAlpha:</strong> transparency value. but where do we store this? Usually in alpha channel. but with RGBM, alpha channel is used for the multiplier… eh… eh… oh yeah! there is something called "<strong><em>premultiplied alpha.</em></strong>" by multiplying alpha value to SrcColor in shader, you can still get this working. yay?</li>
  <li><strong>InvSrcAlpha</strong>: but this is where we fail miserably. We don't have transparency value anymore, and there's no easy-n-efficient way to pre-multiply InvSrcAlpha to DestColour……. yes…. we are doomed.</li>
</ul>

<h1 id="existing-solution">Existing Solution</h1>
<p>So what did we do to solve this problem? eh.. nothing… We simply bypassed this problem by introducing a separate off-screen buffer. We drew all semi-transparent objects onto this buffer with no HDR encoding, and merged the result onto the scene buffer later after tone mapping was done on the HDR(opaque) buffer.</p>

<p>So basically you get HDR only on opaque objects and all semi transparent objects will be in LDR. But merging, or running an extra full-screen pass, was also slow, so we experimented with half-res or quarter-res approaches here to counter-balance the extra cost of keeping another render target.</p>

<p>Well, but it still use more memory than simply using only a RGBM buffer.</p>

<h1 id="blendable-rgbm">Blendable RGBM</h1>
<p>So here I present my hack. Blendable RGBM. Here is a short summary.</p>

<ul>
  <li>it blends transparent objects in a mathematically correct way</li>
  <li>so it doesn't use any extra memory</li>
  <li>transparent pixels reuses the multipliers from the opaque pixels. which are already in the render target</li>
  <li>but it often suffers from lower precision, so if there is a huge difference in range between the opaque and alpha pixels
    <ul>
      <li>you might see the bending effect (when alpha objects are darkening), and</li>
      <li>the alpha objects might not be able to brighten pixels over what the opaque multiplier can allow</li>
    </ul>
  </li>
</ul>

<p>Okay, now some more details….</p>

<h1 id="making-math-work">Making Math Work</h1>
<p>Let's see the RGBM blending formula again:</p>

<pre><code>( DestColour * DestMultiplier * InvSrcAlpha + SrcColor * SrcAlpha ) / SrcMultiplier
</code></pre>

<p>I said we are failing miserably because of InvSrcAlpha. And this was because we were filling shader's alpha output with SrcMultiplier. So what are we going to do about it? Just throw away SrcMultiplier… LOL…. Instead, we will simply match SrcMultiplier to DestMultiplier.. After this hackery hack, the formula becomes this:</p>

<pre><code>( DestColour * DestMultiplier * InvSrcAlpha + SrcColor * SrcAlpha ) / DestMultiplier
</code></pre>

<p>Once simplified, it becomes like this:</p>

<pre><code>DestColour * InvSrcAlpha + SrcColor * SrcAlpha / DestMultiplier
</code></pre>

<p>Alright, so now alpha channel is not used, so we can output our SrcAlpha here.</p>

<h1 id="setting-up-correct-blending-render-states">Setting Up Correct Blending Render States</h1>
<p>I love to mess with hardware blending operations to make a new thing. <a href="http://www.popekim.com/2012/10/siggraph-2012-screen-space-decals-in.html">I've done this once with Screen Space Decals before</a>. And I did it again here!</p>

<p>To make this magic work, we need to change render states like this:</p>
<ul>
  <li><strong>SrcBlend</strong>: DestAlpha</li>
  <li><strong>DestBlend</strong>: InvSrcAlpha</li>
</ul>

<p>After this change, the blending becomes very similar to the above formula with one exception: multiplying of SrcAlpha is missing. Since we are already setting DestAlpha as SrcBlend, we can't set SrcAlpha to the blending unit. The solution? Premultiplied alpha again. :-) Premultiply SrcAlpha to SrcColor in shader.</p>

<p>So are we good? no.. not really. With our current blending states setup, we get this:</p>

<pre><code>DestColour * InvSrcAlpha + SrcColor * SrcAlpha * DestMultiplier
</code></pre>

<p>Doh! We are multiplying DestMultiplier!! But we have to divide it :( To fix this, we will change RGBM encoding and decoding a bit.</p>

<h1 id="changing-rgbm-encodingdecoding">Changing RGBM Encoding/Decoding</h1>
<p>This is essentially how "original" RGBM encoding works:</p>
<ul>
  <li><strong>M</strong>: max(RGB)</li>
  <li><strong>encoding</strong>: RGB / M</li>
  <li><strong>decoding</strong>: RGB * M</li>
  <li><strong>alpha encoding</strong>: M / 6</li>
</ul>

<p>To make it work with our new way, we simply reverse M, so that we multiply while encoding and divide while decoding. This will be something like this.</p>

<ul>
  <li><strong>M</strong>: 1 / clamp( length(RGB), 1, 6 )</li>
  <li><strong>encoding</strong>: RGB * M</li>
  <li><strong>decoding</strong>: RGB / M</li>
  <li><strong>alpha encoding</strong>: M</li>
</ul>

<p>The reason why I used length(RGB) instead of max(RGB) was to give it some extra room which alpha objects later can use to brighten the pixels. How I get M is very hacky. Maybe I can replace two 1s with much lower value like 0.125 to allow better precision in LDR. But keeping the min range to 1 guarantees that full LDR range is available for the alpha pass. But, I'm pretty sure someone can come up with a better way of calculating M here. :)</p>

<h1 id="finally-new-blending-formula">Finally New Blending Formula</h1>
<p>With all the changes up to here, our new blending formula looks like this:</p>

<pre><code>( DestColour / DestMultiplier * InvSrcAlpha + SrcColor * SrcAlpha ) * DestMultiplier
</code></pre>

<p>Once simplified, it becomes this:</p>

<pre><code>DestColour * InvSrcAlpha + SrcColor * SrcAlpha * DestMultiplier
</code></pre>

<p>Oh, hello there! This is exactly what our blending render states setup gave us! Yay! it works!</p>

<h1 id="disabling-alpha-write">Disabling Alpha Write**</h1>
<p>But wait.. if we output our transparency value in alpha channel, the multiplier in HDR buffer will be overwritten, right? We don't want this to happen. We need the alpha value only for blending, so we have to make sure this value is not written to the render target.</p>

<p>We can do it easily by masking alpha from color write. Another render state change will do the magic.</p>

<h1 id="additive-blending">Additive Blending</h1>
<p>My way also works with additive blending too. Set this blending states:</p>
<ul>
  <li><strong>SrcBlend</strong>: DestAlpha</li>
  <li><strong>DestBlend</strong>: One</li>
</ul>

<h1 id="caution">Caution</h1>
<p>As I mentioned earlier, this approach suffers from two side effects.</p>

<ul>
  <li>When the transparent objects darkens pixels too much, you will see bending effects due to the lack of precision with this approach. This happens only when the dest pixel was in HDR range.</li>
  <li>Transparent objects cannot brighten what's already written in the opaque pass too much.</li>
</ul>

<p>Using blendable RGBM would make sense only in certain conditions. I have seen those conditions personally. So use it only when you can't afford separate offscreen buffer for memory or performance reasons and when you are willing to sacrifice visual qualities in return. After all, it's a trade-off between visual quality and memory use.</p>

<p><strong><em>p.s.</em></strong>
If you are working on newer consoles, HDR packing might not be needed anymore. But I'm pretty sure there are still a lot of developers who are stuck with older machines, so hopefully they will find this post helpful. :)</p>


                    </section>
                
                <footer class="pt-4 pt-md-5">
                    <h2 class="h4">Related Posts</h2>
                    <ul class="list-unstyled">
                        
                        <li><a href="/en/2015/02/18/tales-of-multiply-map-and-gamma.html">Tales of Multiply Map and Gamma Correction</a></li>
                        
                        <li><a href="/en/2015/02/09/intro-to-shader-programming-book.html">Introduction to Shader Programming</a></li>
                        
                        <li><a href="/en/2015/01/26/intro-to-shader-06-toon-shader.html">06. Love Cartoons? Here's Toon Shader</a></li>
                        
                    </ul>
                </footer>
                
                <footer>
                    
<script src="https://giscus.app/client.js"
    data-repo="popekim/blog.popekim.com-comments-en"
    data-repo-id="R_kgDOONEmWA"
    data-category="Comments"
    data-category-id="DIC_kwDOONEmWM4CoXIN"
    data-mapping="pathname"
    data-strict="1"
    data-reactions-enabled="1"
    data-emit-metadata="0"
    data-input-position="top"
    data-theme="light"
    data-lang="en"
    crossorigin="anonymous"
    async>
</script>
                </footer>
            </article>
        </div>
    </div>
</div>
    </div>
    
    <footer class="site-footer position-absolute border-top">
    <div class="container">
        <div class="row">
            <div class="col-12 col-md-5 pl-sm-0 pl-lg-6">
                <div>
                    <span class="ml-1">Copyright © 2008 - 2026. Pope Kim</span>
                </div>
            </div>
            <div class="col col-md-5 m-0 p-sm-0 text-md-right">
                <a class="mr-sm-3 mr-0 text-secondary text-nowrap font-weight-bold" href="/ko">한국어</a>
                <span class="h5 opacity-75"><a href="/en/feed.xml" class="badge badge-dark"><i class="fas fa-rss"></i></a></span>
                <span class="h5 opacity-75"><a href="https://www.youtube.com/channel/UCTkPfbt3vgJUwJUMWsBe0yw" class="badge badge-dark" target="_blank"><i class="fab fa-youtube"></i></a></span>
                <span class="h5 opacity-75"><a href="https://x.com/blindrenderer" class="badge badge-dark" target="_blank"><i class="fab fa-twitter"></i></a></span>
                <span class="h5 opacity-75"><a href="https://www.linkedin.com/in/popekim/" class="badge badge-dark" target="_blank"><i class="fab fa-linkedin-in"></i></a></span>
                <span class="h5 opacity-75"><a href="https://www.github.com/popekim/" class="badge badge-dark" target="_blank"><i class="fab fa-github"></i></a></span>
            </div>
        </div>
    </div>
</footer>
    
<script src="/en/assets/lib/jquery/jquery-3.7.1.slim.min.js"></script>
<script src="/en/assets/lib/bootstrap/js/bootstrap.bundle.js"></script>
<script src="/en/assets/lib/prism/js/prism.min.js"></script>
<script src="/en/assets/lib/prism/js/prism-asm6502.min.js"></script>
<script src="/en/assets/lib/prism/js/prism-c.min.js"></script>
<script src="/en/assets/lib/prism/js/prism-cpp.min.js"></script>
<script src="/en/assets/lib/prism/js/prism-csharp.min.js"></script>
<script src="/en/assets/lib/prism/js/prism-java.min.js"></script>
<script src="/en/assets/js/prism/prism-masm.min.js"></script>
<script src="/en/assets/js/saveLangToCookie.js" type="text/javascript"></script>

</body>

</html>