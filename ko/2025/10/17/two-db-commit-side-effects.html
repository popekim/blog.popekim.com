<!DOCTYPE html>
<html lang="ko">


<head>

    <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-NHD74QDQ');</script>
    <!-- End Google Tag Manager -->


    <link href="http://gmpg.org/xfn/11" rel="profile">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="content-type" content="text/html; charset=utf-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5">

    <title>두 개의 DB에 동시에 쓰면서 사이드 이펙트를 최소화하는 방법 | 포프머신</title>
    
    
    
    <link rel="stylesheet" href="/ko/assets/lib/bootstrap/css/bootstrap.min.css" />
    <link rel="stylesheet" href="/ko/assets/css/site.css?1762029392655704193" />
    <link rel="stylesheet" href="/ko/assets/css/prism-pocu.min.css" />

    <link rel="shortcut icon" href="/ko/assets/favicon.ico" />

    <link rel="canonical" href="https://blog.popekim.com/ko/2025/10/17/two-db-commit-side-effects.html" />

<link type="application/atom+xml" rel="alternate" href="https://blog.popekim.com/ko/feed.xml" title="포프머신 | 모든글" />
<link type="application/atom+xml" rel="alternate" href="https://blog.popekim.com/ko/feed/dev.xml" title="포프머신 | 개발" />
<link type="application/atom+xml" rel="alternate" href="https://blog.popekim.com/ko/feed/music.xml" title="포프머신 | 음악" />
<link type="application/atom+xml" rel="alternate" href="https://blog.popekim.com/ko/feed/personal.xml" title="포프머신 | 개인" />

    <link rel="alternate" href="https://blog.popekim.com/ko/2025/10/17/two-db-commit-side-effects.html" hreflang="ko" />
    <link rel="alternate" href="https://blog.popekim.com/en/2025/10/17/two-db-commit-side-effects.html" hreflang="en" />

    <script defer src="https://use.fontawesome.com/releases/v5.15.4/js/all.js" integrity="sha384-rOA1PnstxnOBLzCLMcre8ybwbTmemjzdNlILg8O7z1lUkLXozs4DHonlDtnE7fpc" crossorigin="anonymous"></script>
    
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1575918182992085" crossorigin="anonymous"></script>
    

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;700&subset=korean&display=block" rel="stylesheet">
</head>

<body>

    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NHD74QDQ"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->

    
<nav class="navbar navbar-expand-lg fixed-top navbar-light shadow-sm px-3 px-sm-0 py-lg-3 bg-white">
    <div class="container">
        <a class="navbar-brand" href="/ko/">
            <img class="mt-2 mb-2" src="/ko/assets/img/navbar_logo.png" />
        </a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavDropdown"
            aria-controls="navbarNavDropdown" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNavDropdown">
<ul class="navbar-nav ml-auto mr-lg-3">
    <li class="nav-item">
        <a class="nav-link font-weight-bold" href="/ko/about.html">소개</a>
    </li>
    <li class="nav-item">
        <a class="nav-link font-weight-bold " href="/ko/books.html">저서목록</a>
    </li>
    <li class="nav-item">
        <a class="nav-link font-weight-bold" href="/ko/archives/">모든글</a>
    </li>
    
    
        
        
        
        <li class="nav-item">
            <a class="nav-link font-weight-bold" href="/ko/categories/dev">cat:개발</a>
        </li>
    
        
        
        
        <li class="nav-item">
            <a class="nav-link font-weight-bold" href="/ko/categories/music">cat:음악</a>
        </li>
    
        
        
        
        <li class="nav-item">
            <a class="nav-link font-weight-bold" href="/ko/categories/personal">cat:개인</a>
        </li>
    
</ul>

        </div>
    </div>
</nav>

    <div class="container doc">
        <div class="pt-4 pb-4">
    <div class="row no-gutters">
        <div class="col-lg-10 offset-lg-1">
            <article class="shadow--md px-md-5 py-md-5 border--md rounded">
                <header>
                    <h1 class="card-title text-center mb-4 font-weight-bold">두 개의 DB에 동시에 쓰면서 사이드 이펙트를 최소화하는 방법</h1>
                    <div class="h6 text-muted text-center mb-4 mb-md-5"><img width="70" src="/ko/assets/img/authors/pope.gif" class="rounded-circle mx-auto d-block mb-3" />
                        <span
                            class="h6 border border-dark border-left-0 border-top-0 border-bottom-0 pr-2 pr-lg-3 align-middle">
                            김포프</span>
                        

                        <span class="h6 text-muted align-middle pl-1 pl-lg-2">
                            <i class="far fa-calendar-alt mr-2 opacity-75"></i>
                            2025-10-17
                        </span><ul class="list-inline list-unstyled mt-2">
                            <li class="list-inline-item align-middle opacity-75"><small><i
                                        class="fas fa-tags"></i></small></li>
                        
                            
                             
                            
                            <li class="list-inline-item align-middle">
                                <small><a class="tag-link" href="/ko/tags/csharp/">C#</a></small>
                            </li>
                            
                             
                            
                            <li class="list-inline-item align-middle">
                                <small><a class="tag-link" href="/ko/tags/database/">database</a></small>
                            </li>
                            
                             
                            
                            <li class="list-inline-item align-middle">
                                <small><a class="tag-link" href="/ko/tags/defensive-programming/">방어적프로그래밍</a></small>
                            </li>
                            
                             
                            
                            <li class="list-inline-item align-middle">
                                <small><a class="tag-link" href="/ko/tags/ef-core/">ef core</a></small>
                            </li>
                            
                             
                            
                            <li class="list-inline-item align-middle">
                                <small><a class="tag-link" href="/ko/tags/transaction/">트랜잭션</a></small>
                            </li>
                            
                             
                            
                            <li class="list-inline-item align-middle">
                                <small><a class="tag-link" href="/ko/tags/distributed-transaction/">분산트랜잭션</a></small>
                            </li>
                            
                             
                            
                            <li class="list-inline-item align-middle">
                                <small><a class="tag-link" href="/ko/tags/dev/">개발</a></small>
                            </li>
                            
                             
                            
                            <li class="list-inline-item align-middle">
                                <small><a class="tag-link" href="/ko/tags/dev-diary/">개발일지</a></small>
                            </li></ul></div>
                </header>
                <section class="pt-4 pb-4 pb-md-5 border border-top-0 border-right-0 border-left-0">
                    <p>보통은 데이터를 하나의 데이터베이스에만 저장합니다.<br />
하지만 드물게 <strong>두 개의 물리적으로 다른 DB 서버</strong>에 동시에 데이터를 써야 할 때가 있습니다.</p>

<h2 id="보통-처음엔-아무-생각-없이-이렇게-한다">보통 처음엔 아무 생각 없이 이렇게 한다</h2>

<p>참고로 이 글에서 보여주는 코드는 C#과 EF Core 기준이다.</p>

<pre><code class="language-csharp">await mDbContext0.SaveChangesAsync();
await mDbContext1.SaveChangesAsync();
</code></pre>

<p>대부분은 그냥 이렇게 두 번 저장합니다.<br />
하지만 이건 <em>언젠가 반드시</em> 깨집니다.</p>

<p>첫 번째 커밋이 끝난 <strong>직후</strong>,</p>
<ul>
  <li>두 번째 DB의 <code>SaveChangesAsync()</code>가 validation 오류나 제약 조건 위반으로 실패하거나</li>
  <li>네트워크가 끊기거나</li>
  <li>전원 장애가 나면</li>
</ul>

<p>결국 첫 번째 DB만 반영되고 두 번째는 실패합니다.<br />
즉, <strong>한쪽만 반영된 상태</strong>, 다시 말해 <strong>데이터 불일치(inconsistency)</strong> 가 생깁니다.</p>

<h2 id="오늘-나는-이렇게-해결했다">오늘 나는 이렇게 해결했다</h2>

<p>⚠️ 이 방법은 완벽하지 않습니다.</p>

<pre><code class="language-csharp">private async Task crossCommitBestEffortAsync()
{
    await using (IDbContextTransaction tx0 = await mDbContext0.Database.BeginTransactionAsync())
    await using (IDbContextTransaction tx1 = await mDbContext1.Database.BeginTransactionAsync())
    {
        // best-effort attempt to make two independent DB commits look atomic
        // still unsafe if:
        //   1) tx0.CommitAsync() succeeds, and
        //   2) power failure happens before tx1.CommitAsync()
        try
        {
            await mDbContext0.SaveChangesAsync();
            await mDbContext1.SaveChangesAsync();

            await tx0.CommitAsync();
            await tx1.CommitAsync();
        }
        catch
        {
            await tx0.RollbackAsync();
            await tx1.RollbackAsync();
            throw;
        }
    }
}
</code></pre>

<p>이 코드는 <strong>각 DB에 별도의 트랜잭션을 열고</strong>,<br />
둘 다 성공적으로 저장되었을 때만 커밋을 시도합니다.</p>

<h2 id="이전-코드와-뭐가-다를까">이전 코드와 뭐가 다를까?</h2>

<p>기존의 아무 생각 없이 짠 방식(<code>SaveChangesAsync()</code> 두 번)에서는<br />
첫 번째 DB 커밋이 성공하고, 두 번째 DB에서 예외가 나면<br />
<strong>이미 커밋된 데이터를 되돌릴 방법이 없습니다.</strong></p>

<p>하지만 위 코드에서는</p>
<ul>
  <li>둘 중 하나라도 <code>SaveChangesAsync()</code>나 <code>CommitAsync()</code>에서 실패하면<br />
<strong>두 트랜잭션 모두 롤백</strong>되도록 보장합니다.</li>
  <li>즉, <strong>정상적인 코드 실행 흐름</strong>에서는 두 DB 모두 커밋되거나 모두 롤백됩니다.</li>
</ul>

<p>이건 "최선의 시도(best effort)" 방식입니다 —
운영체제나 전원이 살아 있는 한, <strong>둘 다 같은 상태로 끝나도록 노력합니다.</strong></p>

<h2 id="그래도-완벽하지-않은-이유">그래도 완벽하지 않은 이유</h2>

<p>문제는 <strong>물리적 장애</strong>입니다. <br />
즉, 코드 레벨에서는 방어했지만, 시스템 레벨에서는 여전히 취약합니다.</p>

<p>예를 들어 이런 순서로 일이 벌어지면 망합니다 👇</p>
<ol>
  <li><code>tx0.CommitAsync()</code> 성공</li>
  <li>전원 장애 or 프로세스 크래시</li>
  <li><code>tx1.CommitAsync()</code> 호출되지 않음</li>
</ol>

<p>이 경우, DB0은 이미 커밋된 상태고 DB1은 커밋되지 않았습니다.<br />
즉, <strong>두 DB의 상태가 달라집니다.</strong></p>

<p>이건 코드로 막을 수 없습니다.<br />
두 DB가 물리적으로 독립된 서버이기 때문입니다.</p>

<h2 id="그래서-미션-크리티컬한-곳에는-부적합">그래서 미션 크리티컬한 곳에는 부적합</h2>

<p>이 방식은 커밋 간의 시간차가 아주 작습니다.<br />
하지만 작다는 건 "거의 동시에"일 뿐, <strong>절대 동시에가 아닙니다.</strong></p>

<p>즉,</p>
<blockquote>
  <p>첫 번째 커밋이 끝나고 두 번째 커밋을 하기 전 0.001초 동안 정전이 나면, 데이터는 불일치 상태로 남습니다.</p>
</blockquote>

<p>그래서 <strong>미션 크리티컬한 트랜잭션(예: 결제, 정산, 주문 처리 등)</strong> 에서는 절대 써서는 안 됩니다.</p>

<h2 id="그럼-왜-나는-이렇게-썼냐면">그럼 왜 나는 이렇게 썼냐면</h2>

<p>이 코드는 <strong>내부 개발용 툴</strong>에서 사용된 패턴입니다.<br />
즉, 일반 유저가 사용하는 서비스는 아니었죠.</p>

<p>문제가 생길 확률도 극히 낮고,<br />
설사 문제가 생겨도 그 순간 <strong>내부 개발자</strong>가 툴을 직접 다루고 있어서<br />
이상한 상태가 생기면 바로 눈치챌 수 있었습니다.</p>

<p>즉, <em>리스크가 매우 낮은 환경</em>이라 이렇게 써도 괜찮았습니다.</p>

<h2 id="제대로-하려면-mq를-써야-한다">제대로 하려면 MQ를 써야 한다</h2>

<p>안전하게 처리하려면 <strong>Message Queue(MQ)</strong> 를 써야 합니다.</p>

<p>단, 단순히 "DB에 먼저 확정 반영하고 그 결과를 큐에 남기는 방식"은 여전히 위험합니다.<br />
DB 커밋 직후 전원이 나가면, 큐에 메시지가 남지 않아 <strong>재처리조차 불가능</strong>하기 때문입니다.</p>

<p>그래서 보통은 <strong>DB에 직접 반영하지 않고</strong>,<br />
먼저 <strong>모든 업데이트 요청을 큐에 넣은 뒤</strong><br />
큐 컨슈머가 DB0, DB1을 차례로 갱신하도록 설계합니다.</p>

<p>이렇게 하면 프로듀서(생산자)는 단 하나의 작업 — 메시지 전송 — 만 수행하고,<br />
장애가 나더라도 큐에 남은 메시지를 통해 <strong>항상 재처리할 수 있습니다.</strong></p>

<p>물론 중복 반영 방지나 pre-validation 같은 보완은 필요하지만,<br />
적어도 데이터 불일치로 망하지는 않습니다.</p>

<p>단, 큐 컨슈머가 두 번째 DB에 반영할 때<br />
validation 오류나 비즈니스 제약 때문에 <strong>정상적으로 저장할 수 없는 경우</strong>도 있습니다.<br />
이런 경우에는 첫 번째 DB에 이미 반영된 데이터를<br />
<strong>보상 트랜잭션(compensating transaction)</strong> 으로 되돌리는 절차가 필요합니다.<br />
즉, 큐 기반 구조라 해도 완전히 자동은 아니며,<br />
데이터 정합성을 유지하기 위한 별도의 롤백 로직이 함께 설계되어야 합니다.</p>

<p>물론 메시지 큐를 도입한다는 건<br />
<strong>결국 또 하나의 프로그램을 돌리고, 또 하나의 저장소를 관리해야 한다는 뜻</strong>입니다.<br />
운영 레이어가 하나 더 생기고,<br />
문제가 생기면 SQL처럼 바로 쿼리로 들여다볼 수도 없어<br />
<strong>디버깅 난이도도 확 올라갑니다.</strong></p>

<p>즉, 안정성은 올라가지만 시스템은 그만큼 복잡해집니다.<br />
그래서 규모가 작거나, 장애 발생 시 수동 대응이 가능한 내부 시스템이라면<br />
굳이 MQ까지 도입하지 않아도 됩니다.<br />
하지만 <strong>안정성이 최우선인 서비스</strong>라면 결국 이 방향으로 가야 합니다.</p>

<p>처음 시작할 때는 복잡한 분산 MQ보다<br />
<strong>Rebus + SQL</strong> 조합을 추천합니다.<br />
설정도 간단하고, 트랜잭션 처리도 깔끔하게 지원합니다.<br />
이전에 관련해서 자세히 다룬 글이 있으니 참고하세요 👇<br />
👉 <a href="/ko/2022/07/17/rebus-for-nonscalable-message-queue.html">간단한 메시지 큐는 Rebus로</a></p>

<h2 id="참고-msdtc는-온프레미스에서만">참고: MSDTC는 온프레미스에서만</h2>

<p>윈도우 환경에서 자체 서버를 돌린다면<br />
<strong>MSDTC (Microsoft Distributed Transaction Coordinator)</strong> 로<br />
여러 DB를 완전한 분산 트랜잭션으로 묶을 수 있습니다.</p>

<pre><code class="language-csharp">using (var scope = new TransactionScope(TransactionScopeAsyncFlowOption.Enabled))
{
    await mDbContext0.SaveChangesAsync();
    await mDbContext1.SaveChangesAsync();
    scope.Complete();
}
</code></pre>

<p>이건 완전히 atomic합니다.<br />
하지만 <strong>Azure SQL Database에서는 MSDTC가 지원되지 않습니다.</strong></p>

<p>클라우드 환경에서는 결국<br />
이런 "best effort"나 "queue 기반 보상 트랜잭션" 외엔 방법이 없습니다.</p>

<h2 id="결론">결론</h2>
<ol>
  <li>그냥 <code>SaveChangesAsync()</code> 두 번 부르면 언젠가 문제 생긴다.</li>
  <li><code>crossCommitBestEffortAsync()</code>는 정상 시나리오에서는 일관되게 동작하지만, <strong>전원 장애 등 물리적 장애에는 여전히 취약하다.</strong></li>
  <li>미션 크리티컬 시스템에는 절대 부적합하다.</li>
  <li>안전하게 하려면 <strong>Queue 기반 설계</strong>로 가야 한다.</li>
  <li><strong>MSDTC는 온프레미스에서만 동작</strong>한다.</li>
</ol>

<p>결국 "commit 두 번"은 사람을 배신하지만, "queue"는 시스템을 구한다. 😏</p>

<hr />

<p>멀티 DB 트랜잭션이 어려운 이유는 결국 <strong>멀티스레딩과 동시성 제어의 본질적인 복잡함</strong> 때문이다.<br />
관련 내용은 아래 PopeTV 영상 두 개를 보면 더 잘 이해할 수 있다 👇</p>

<p>🎥 <a href="https://www.youtube.com/watch?v=yl8_ZRDA5pw">멀티스레딩 마스터하기: 10년의 여정 (PopeTV)</a><br />
🎥 <a href="https://www.youtube.com/watch?v=M1e9nmmD3II">
바람직한 멀티스레딩 구조 (PopeTV)</a></p>

                    
                    
                    
                    <section class="pt-5 pb-3 text-center welcome-to-pocu">
                        <a href="https://pocu.academy/ko/Courses/COMP2200" class="d-inline-block border text-decoration-none text-left rounded to-pocu" id="a001">
                            <div class="d-flex flex-row align-content-center">
                                <div class="d-none d-md-block border border-top-0 border-bottom-0 border-left-0">
                                    <img src="https://blog.pocu.academy/ko/assets/img/logos/COMP2200.png" alt="img" />
                                </div>
                                <div class="d-flex flex-column justify-content-center px-4 py-3">
                                    <h2 class="headlines font-weight-bold">
                                        포인터의 확실한 이해 | C 언어 독학 | 모든 프로그래밍 언어의 어머니
                                    </h2>
                                    <p class="description m-0">5차 산업혁명을 책임질 컴퓨터 하드웨어 지식! POCU 아카데미에서 C 언어를 마스터하세요!</p>
                                </div>
                            </div>
                        </a>
                    </section></section>
                
                <footer class="pt-4 pt-md-5">
                    <h2 class="h4">관련 글</h2>
                    <ul class="list-unstyled">
                        
                        <li><a href="/ko/2025/08/31/aspnet-core-facebook-login-graph-api-management.html">페북 Graph API 자주 끊기는 시대, ASP.NET Core 로그인은 이렇게 관리해야 한다</a></li>
                        
                        <li><a href="/ko/2025/10/23/aws-outage-multi-cloud.html">AWS가 멈췄다고요? 멀티클라우드가 답은 아니다</a></li>
                        
                        <li><a href="/ko/2025/08/17/tempdata-helper.html">재사용은커녕 단 한 번 호출... 그런데도 합당했던 함수</a></li>
                        
                    </ul>
                </footer>
                
                <footer>
                    
<script src="https://giscus.app/client.js"
    data-repo="popekim/blog.popekim.com-comments-ko"
    data-repo-id="R_kgDOOND35A"
    data-category="Comments"
    data-category-id="DIC_kwDOOND35M4CoXGy"
    data-mapping="pathname"
    data-strict="1"
    data-reactions-enabled="1"
    data-emit-metadata="0"
    data-input-position="top"
    data-theme="light"
    data-lang="ko"
    crossorigin="anonymous"
    async>
</script>
                </footer>
            </article>
        </div>
    </div>
</div>
    </div>
    
    <footer class="site-footer position-absolute border-top">
    <div class="container">
        <div class="row">
            <div class="col-12 col-md-5 pl-sm-0 pl-lg-6">
                <div>
                    <span class="ml-1">Copyright © 2010 - 2025. Pope Kim</span>
                </div>
            </div>
            <div class="col col-md-5 m-0 p-sm-0 text-md-right">
                <a class="mr-sm-3 mr-0 text-secondary text-nowrap font-weight-bold" href="/en">English</a>
                <span class="h5 opacity-75"><a href="/ko/feed.xml" class="badge badge-dark"><i class="fas fa-rss"></i></a></span>
                <span class="h5 opacity-75"><a href="https://www.youtube.com/c/PopeTV/" class="badge badge-dark" target="_blank"><i class="fab fa-youtube"></i></a></span>
                <span class="h5 opacity-75"><a href="https://x.com/blindrendererkr" class="badge badge-dark" target="_blank"><i class="fab fa-twitter"></i></a></span>
                <span class="h5 opacity-75"><a href="https://www.linkedin.com/in/popekim/" class="badge badge-dark" target="_blank"><i class="fab fa-linkedin-in"></i></a></span>
                <span class="h5 opacity-75"><a href="https://www.github.com/popekim/" class="badge badge-dark" target="_blank"><i class="fab fa-github"></i></a></span>
            </div>
        </div>
    </div>
</footer>
    
<script src="/ko/assets/lib/jquery/jquery-3.7.1.slim.min.js"></script>
<script src="/ko/assets/lib/bootstrap/js/bootstrap.bundle.js"></script>
<script src="/ko/assets/lib/prism/js/prism.min.js"></script>
<script src="/ko/assets/lib/prism/js/prism-asm6502.min.js"></script>
<script src="/ko/assets/lib/prism/js/prism-c.min.js"></script>
<script src="/ko/assets/lib/prism/js/prism-cpp.min.js"></script>
<script src="/ko/assets/lib/prism/js/prism-csharp.min.js"></script>
<script src="/ko/assets/lib/prism/js/prism-java.min.js"></script>
<script src="/ko/assets/js/prism/prism-masm.min.js"></script>
<script src="/ko/assets/js/saveLangToCookie.js" type="text/javascript"></script>

</body>

</html>